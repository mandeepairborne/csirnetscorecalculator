<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Response Fetcher</title>
    <style>
        /* ... (keep previous styles) ... */
    </style>
</head>
<body>
    <div class="container">
        <h1>Student Response Sheet Fetcher</h1>
        <input type="text" id="urlInput" 
               placeholder="Enter response sheet URL"
               value="https://example.com/response-sheet.html">
        <button onclick="fetchDetails()">Fetch Details</button>
        <div id="output"></div>
    </div>

    <script>
        async function fetchDetails() {
            const url = document.getElementById('urlInput').value;
            const output = document.getElementById('output');
            output.innerHTML = 'Loading...';

            try {
                // Use CORS proxy to bypass restrictions
                const proxyUrl = 'https://cors-anywhere.herokuapp.com/';
                const response = await fetch(proxyUrl + url);
                
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const htmlText = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(htmlText, 'text/html');

                // Improved detail extraction
                const getDetail = (label) => {
                    const cells = Array.from(doc.querySelectorAll('td'));
                    const cell = cells.find(td => 
                        td.textContent.trim().startsWith(label)
                    );
                    
                    if (!cell) return 'Not found';
                    const valueCell = cell.closest('tr').querySelector('td:last-child');
                    return valueCell ? valueCell.textContent.trim() : 'Not found';
                };

                const studentDetails = {
                    rollNo: getDetail('Roll No'),
                    regNo: getDetail('Registration No'),
                    name: getDetail('Candidate Name'),
                    module: getDetail('Module Name'),
                    examDate: getDetail('Exam Date'),
                    batch: getDetail('Exam Batch')
                };

                // Image handling
                const getImage = (index) => {
                    const img = doc.querySelectorAll('table.top-viewQP img')[index];
                    if (!img) return null;
                    const src = img.getAttribute('src');
                    return new URL(src, url).href;
                };

                // Question parsing
                const questions = Array.from(doc.querySelectorAll('fieldset')).map(fieldset => {
                    const header = fieldset.querySelector('.legend-text');
                    if (!header) return null;
                    
                    const [questionNo, questionId] = header.textContent
                        .split('/')
                        .map(s => s.replace(/\D/g, '').trim());
                    
                    return {
                        questionNo,
                        questionId,
                        chosenOption: fieldset.querySelector('[checked]')
                            ?.closest('tr')
                            ?.querySelector('span')
                            ?.textContent || 'Not found'
                    };
                }).filter(q => q);

                displayResults(studentDetails, getImage, questions);

            } catch (error) {
                console.error('Fetch error:', error);
                output.innerHTML = `Error: ${error.message}`;
            }
        }

        function displayResults(details, getImage, questions) {
            const output = document.getElementById('output');
            output.innerHTML = `
                <div class="student-info">
                    <h2>Student Details</h2>
                    <p><strong>Roll No:</strong> ${details.rollNo}</p>
                    <p><strong>Registration No:</strong> ${details.regNo}</p>
                    <p><strong>Name:</strong> ${details.name}</p>
                    <p><strong>Module:</strong> ${details.module}</p>
                    <p><strong>Exam Date:</strong> ${details.examDate}</p>
                    <p><strong>Batch:</strong> ${details.batch}</p>
                    <div>
                        ${getImage(0) ? `<img src="${getImage(0)}" alt="Registered Photo">` : ''}
                        ${getImage(1) ? `<img src="${getImage(1)}" alt="Exam Day Photo">` : ''}
                    </div>
                </div>

                <div class="questions">
                    <h3>Attempted Questions (${questions.length})</h3>
                    ${questions.map(q => `
                        <div class="question">
                            <p><strong>Q${q.questionNo}</strong> 
                            (ID: ${q.questionId})</p>
                            <p>Selected: ${q.chosenOption}</p>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        
// Add the correct answers object
const CORRECT_ANSWERS = {
    "705101": "2",
    "705102": "4",
    "705103": "4",
    "705104": "1",
    "705105": "1",
    "705106": "2",
    "705107": "4",
    "705108": "2",
    "705109": "4",
    "705110": "1",
    "705111": "2",
    "705112": "3",
    "705113": "4",
    "705114": "1",
    "705115": "2",
    "705116": "4",
    "705117": "4",
    "705118": "2",
    "705119": "2",
    "705120": "2",
    "705121": "4",
    "705122": "3",
    "705123": "3",
    "705124": "2",
    "705125": "1",
    "705126": "2",
    "705127": "2",
    "705128": "3",
    "705129": "3",
    "705130": "2",
    "705131": "3",
    "705132": "1",
    "705133": "2",
    "705134": "2",
    "705135": "1",
    "705136": "3",
    "705137": "3",
    "705138": "4",
    "705139": "2",
    "705140": "4",
    "705141": "2",
    "705142": "2",
    "705143": "3",
    "705144": "4",
    "705145": "1",
    "705146": "4",
    "705147": "2",
    "705148": "1",
    "705149": "4",
    "705150": "3",
    "705151": "1",
    "705152": "4",
    "705153": "1",
    "705154": "1",
    "705155": "3",
    "705156": "4",
    "705157": "4",
    "705158": "3",
    "705159": "4",
    "705160": "4",
    "705161": "2",
    "705162": "4",
    "705163": "1",
    "705164": "4",
    "705165": "3",
    "705166": "3",
    "705167": "1",
    "705168": "1",
    "705169": "4",
    "705170": "1",
    "705171": "2",
    "705172": "4",
    "705173": "2",
    "705174": "1",
    "705175": "2"
};

async function fetchDetails() {
    // ... (previous fetch code remains the same until question extraction) ...

    // Calculate scores
    const scoreDetails = {
        twoMarks: { correct: 0, incorrect: 0, total: 0 },
        threeHalfMarks: { correct: 0, incorrect: 0, total: 0 },
        fiveMarks: { correct: 0, incorrect: 0, total: 0 }
    };

    questions.forEach(q => {
        if (!CORRECT_ANSWERS.hasOwnProperty(q.questionId)) return;

        const correctAnswer = CORRECT_ANSWERS[q.questionId];
        const isCorrect = q.chosenOption === correctAnswer;
        const isAttempted = q.chosenOption !== 'Not found';

        let marks = 0;
        if (q.questionId >= 705101 && q.questionId <= 705120) {
            marks = 2;
            handleMarks(scoreDetails.twoMarks, isCorrect, isAttempted, marks);
        } else if (q.questionId >= 705121 && q.questionId <= 705145) {
            marks = 3.5;
            handleMarks(scoreDetails.threeHalfMarks, isCorrect, isAttempted, marks);
        } else if (q.questionId >= 705146 && q.questionId <= 705175) {
            marks = 5;
            handleMarks(scoreDetails.fiveMarks, isCorrect, isAttempted, marks);
        }
    });

    // Calculate totals
    const totalScore = [
        scoreDetails.twoMarks.total,
        scoreDetails.threeHalfMarks.total,
        scoreDetails.fiveMarks.total
    ].reduce((a, b) => a + b, 0);

    // Display results with score
    displayResults(studentDetails, getImage, questions, scoreDetails, totalScore);
}

function handleMarks(category, isCorrect, isAttempted, marks) {
    if (!isAttempted) return;
    
    if (isCorrect) {
        category.correct++;
        category.total += marks;
    } else {
        category.incorrect++;
        category.total -= marks/4;
    }
}

function displayResults(details, getImage, questions, scores, total) {
    const output = document.getElementById('output');
    output.innerHTML = `
        <!-- Previous student info display remains same -->
        
        <div class="score-summary">
            <h3>Exam Score: ${total.toFixed(2)}</h3>
            <h4>Breakdown:</h4>
            <p>2 Marks Questions:
                Correct: ${scores.twoMarks.correct},
                Incorrect: ${scores.twoMarks.incorrect},
                Score: ${scores.twoMarks.total.toFixed(2)}
            </p>
            <p>3.5 Marks Questions:
                Correct: ${scores.threeHalfMarks.correct},
                Incorrect: ${scores.threeHalfMarks.incorrect},
                Score: ${scores.threeHalfMarks.total.toFixed(2)}
            </p>
            <p>5 Marks Questions:
                Correct: ${scores.fiveMarks.correct},
                Incorrect: ${scores.fiveMarks.incorrect},
                Score: ${scores.fiveMarks.total.toFixed(2)}
            </p>
        </div>

        <!-- Questions display remains same -->
    `;
}

    </script>
</body>
</html>
