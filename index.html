<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Response Fetcher</title>
    <style>
        /* ... (keep previous styles) ... */
    </style>
</head>
<body>
    <div class="container">
        <h1>Student Response Sheet Fetcher</h1>
        <input type="text" id="urlInput" 
               placeholder="Enter response sheet URL"
               value="https://example.com/response-sheet.html">
        <button onclick="fetchDetails()">Fetch Details</button>
        <div id="output"></div>
    </div>

    <script>
        async function fetchDetails() {
            const url = document.getElementById('urlInput').value;
            const output = document.getElementById('output');
            output.innerHTML = 'Loading...';

            try {
                // Use CORS proxy to bypass restrictions
                const proxyUrl = 'https://cors-anywhere.herokuapp.com/';
                const response = await fetch(proxyUrl + url);
                
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const htmlText = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(htmlText, 'text/html');

                // Improved detail extraction
                const getDetail = (label) => {
                    const cells = Array.from(doc.querySelectorAll('td'));
                    const cell = cells.find(td => 
                        td.textContent.trim().startsWith(label)
                    );
                    
                    if (!cell) return 'Not found';
                    const valueCell = cell.closest('tr').querySelector('td:last-child');
                    return valueCell ? valueCell.textContent.trim() : 'Not found';
                };

                const studentDetails = {
                    rollNo: getDetail('Roll No'),
                    regNo: getDetail('Registration No'),
                    name: getDetail('Candidate Name'),
                    module: getDetail('Module Name'),
                    examDate: getDetail('Exam Date'),
                    batch: getDetail('Exam Batch')
                };

                // Image handling
                const getImage = (index) => {
                    const img = doc.querySelectorAll('table.top-viewQP img')[index];
                    if (!img) return null;
                    const src = img.getAttribute('src');
                    return new URL(src, url).href;
                };

                // Question parsing
                const questions = Array.from(doc.querySelectorAll('fieldset')).map(fieldset => {
                    const header = fieldset.querySelector('.legend-text');
                    if (!header) return null;
                    
                    const [questionNo, questionId] = header.textContent
                        .split('/')
                        .map(s => s.replace(/\D/g, '').trim());
                    
                    return {
                        questionNo,
                        questionId,
                        chosenOption: fieldset.querySelector('[checked]')
                            ?.closest('tr')
                            ?.querySelector('span')
                            ?.textContent || 'Not found'
                    };
                }).filter(q => q);

                displayResults(studentDetails, getImage, questions);

            } catch (error) {
                console.error('Fetch error:', error);
                output.innerHTML = `Error: ${error.message}`;
            }
        }

        function displayResults(details, getImage, questions) {
            const output = document.getElementById('output');
            output.innerHTML = `
                <div class="student-info">
                    <h2>Student Details</h2>
                    <p><strong>Roll No:</strong> ${details.rollNo}</p>
                    <p><strong>Registration No:</strong> ${details.regNo}</p>
                    <p><strong>Name:</strong> ${details.name}</p>
                    <p><strong>Module:</strong> ${details.module}</p>
                    <p><strong>Exam Date:</strong> ${details.examDate}</p>
                    <p><strong>Batch:</strong> ${details.batch}</p>
                    <div>
                        ${getImage(0) ? `<img src="${getImage(0)}" alt="Registered Photo">` : ''}
                        ${getImage(1) ? `<img src="${getImage(1)}" alt="Exam Day Photo">` : ''}
                    </div>
                </div>

                <div class="questions">
                    <h3>Attempted Questions (${questions.length})</h3>
                    ${questions.map(q => `
                        <div class="question">
                            <p><strong>Q${q.questionNo}</strong> 
                            (ID: ${q.questionId})</p>
                            <p>Selected: ${q.chosenOption}</p>
                        </div>
                    `).join('')}
                </div>
            `;
        }
    </script>
</body>
</html>
